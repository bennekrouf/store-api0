{"timestamp":"2026-01-29T14:08:58.034771Z","level":"INFO","fields":{"message":"Starting API Store service","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.034666+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035087Z","level":"INFO","fields":{"message":"Executable path: Ok(\"/Users/mb/code/api0/store/target/debug/store\")","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035086+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035176Z","level":"INFO","fields":{"message":"Working directory: Ok(\"/Users/mb/code/api0/store\")","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035175+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035316Z","level":"DEBUG","fields":{"message":"Checking config path: \"/Users/mb/code/api0/store/target/debug/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035314+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035365Z","level":"DEBUG","fields":{"message":"Checking config path: \"/Users/mb/code/api0/store/target/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035364+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035399Z","level":"DEBUG","fields":{"message":"Checking config path: \"/Users/mb/code/api0/store/target/debug/../config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035398+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035434Z","level":"DEBUG","fields":{"message":"Checking config path: \"/opt/api0/store/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035433+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035476Z","level":"DEBUG","fields":{"message":"Checking config path: \"/Users/mb/code/api0/store/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035475+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035513Z","level":"INFO","fields":{"message":"Found config at: \"/Users/mb/code/api0/store/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035512+00:00"}}
{"timestamp":"2026-01-29T14:08:58.035570Z","level":"INFO","fields":{"message":"Loading configuration from: \"/Users/mb/code/api0/store/config.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.035569+00:00"}}
{"timestamp":"2026-01-29T14:08:58.036172Z","level":"INFO","fields":{"message":"Successfully loaded configuration","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.036170+00:00"}}
{"timestamp":"2026-01-29T14:08:58.036264Z","level":"INFO","fields":{"message":"Using YAML formatter at: http://127.0.0.1:6001/format-yaml","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.036262+00:00"}}
{"timestamp":"2026-01-29T14:08:58.036317Z","level":"INFO","fields":{"message":"Using DATABASE_URL from environment: postgresql://api_store_dev_user:Salma2025!@localhost:5433/postgres","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.036315+00:00"}}
{"timestamp":"2026-01-29T14:08:58.036455Z","level":"INFO","fields":{"message":"Initializing EndpointStore with PostgreSQL","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.036432+00:00"}}
{"timestamp":"2026-01-29T14:08:58.209953Z","level":"DEBUG","fields":{"message":"executing statement batch: -- PostgreSQL Schema\n\n-- Keep user_preferences table for preferences and credit\nCREATE TABLE IF NOT EXISTS user_preferences (\n    email VARCHAR NOT NULL,\n    hidden_defaults TEXT NOT NULL DEFAULT '',\n    credit_balance BIGINT NOT NULL DEFAULT 0,\n    PRIMARY KEY (email)\n);\n\n-- Tenants table\nCREATE TABLE IF NOT EXISTS tenants (\n    id VARCHAR PRIMARY KEY,\n    name VARCHAR NOT NULL,\n    credit_balance BIGINT NOT NULL DEFAULT 0,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()\n);\n\n-- Tenant Users table (User-Tenant relationship)\nCREATE TABLE IF NOT EXISTS tenant_users (\n    tenant_id VARCHAR NOT NULL,\n    email VARCHAR NOT NULL,\n    role VARCHAR NOT NULL DEFAULT 'member', -- owner, member\n    PRIMARY KEY (tenant_id, email),\n    FOREIGN KEY (tenant_id) REFERENCES tenants(id),\n    FOREIGN KEY (email) REFERENCES user_preferences(email)\n);\n\n-- Add default_tenant_id to user_preferences\nDO $$\nBEGIN\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'user_preferences' AND column_name = 'default_tenant_id') THEN\n        ALTER TABLE user_preferences ADD COLUMN default_tenant_id VARCHAR;\n        -- We cannot easily FK to tenants here if we want to circular reference safely, but optional\n        -- ALTER TABLE user_preferences ADD CONSTRAINT fk_default_tenant FOREIGN KEY (default_tenant_id) REFERENCES tenants(id);\n    END IF;\nEND $$;\n\n-- API keys table\nCREATE TABLE IF NOT EXISTS api_keys (\n    id VARCHAR NOT NULL,\n    email VARCHAR NOT NULL,\n    key_hash VARCHAR NOT NULL,\n    key_prefix VARCHAR NOT NULL,\n    key_name VARCHAR NOT NULL,\n    generated_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    last_used TIMESTAMP WITH TIME ZONE,\n    usage_count BIGINT NOT NULL DEFAULT 0,\n    is_active BOOLEAN NOT NULL DEFAULT true,\n    PRIMARY KEY (id),\n    FOREIGN KEY (email) REFERENCES user_preferences(email)\n);\n\n-- API Groups table\nCREATE TABLE IF NOT EXISTS api_groups (\n    id VARCHAR PRIMARY KEY,\n    name VARCHAR NOT NULL,\n    description VARCHAR NOT NULL DEFAULT '',\n    base VARCHAR NOT NULL DEFAULT ''\n);\n\n-- Endpoints table with group reference\nCREATE TABLE IF NOT EXISTS endpoints (\n    id VARCHAR PRIMARY KEY,\n    text VARCHAR NOT NULL,\n    description VARCHAR NOT NULL DEFAULT '',\n    verb VARCHAR NOT NULL DEFAULT 'GET',\n    base VARCHAR NOT NULL DEFAULT '',\n    path VARCHAR NOT NULL DEFAULT '',\n    group_id VARCHAR,\n    FOREIGN KEY (group_id) REFERENCES api_groups(id)\n);\n\n-- User associations for groups\nCREATE TABLE IF NOT EXISTS user_groups (\n    email VARCHAR NOT NULL,\n    group_id VARCHAR NOT NULL,\n    FOREIGN KEY (group_id) REFERENCES api_groups(id),\n    PRIMARY KEY (email, group_id)\n);\n\n-- User endpoint associations\nCREATE TABLE IF NOT EXISTS user_endpoints (\n    email VARCHAR NOT NULL,\n    endpoint_id VARCHAR NOT NULL,\n    FOREIGN KEY (endpoint_id) REFERENCES endpoints(id),\n    PRIMARY KEY (email, endpoint_id)\n);\n\n-- Parameters table\nCREATE TABLE IF NOT EXISTS parameters (\n    endpoint_id VARCHAR,\n    name VARCHAR NOT NULL,\n    description VARCHAR NOT NULL DEFAULT '',\n    required BOOLEAN NOT NULL DEFAULT false,\n    FOREIGN KEY (endpoint_id) REFERENCES endpoints(id)\n);\n\n-- Parameter alternatives\nCREATE TABLE IF NOT EXISTS parameter_alternatives (\n    endpoint_id VARCHAR,\n    parameter_name VARCHAR,\n    alternative VARCHAR NOT NULL,\n    FOREIGN KEY (endpoint_id) REFERENCES endpoints(id)\n);\n\n-- Domains table\nCREATE TABLE IF NOT EXISTS domains (\n    id VARCHAR NOT NULL,\n    email VARCHAR NOT NULL,\n    domain VARCHAR NOT NULL,\n    verified BOOLEAN NOT NULL DEFAULT false,\n    added_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    last_used TIMESTAMP WITH TIME ZONE,\n    verification_token VARCHAR,\n    PRIMARY KEY (id),\n    UNIQUE(email, domain)\n);\n\n-- API usage logs table for detailed tracking\nCREATE TABLE IF NOT EXISTS api_usage_logs (\n    id VARCHAR NOT NULL,\n    key_id VARCHAR NOT NULL,\n    email VARCHAR NOT NULL,\n    endpoint_path VARCHAR NOT NULL,\n    method VARCHAR NOT NULL,\n    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,\n    response_status INTEGER,\n    response_time_ms BIGINT,\n    request_size BIGINT,\n    response_size BIGINT,\n    ip_address VARCHAR,\n    user_agent VARCHAR,\n    usage_estimated BOOLEAN,\n    input_tokens BIGINT,\n    output_tokens BIGINT,\n    total_tokens BIGINT,\n    model_used VARCHAR,\n    metadata JSONB,\n    PRIMARY KEY (id),\n    FOREIGN KEY (key_id) REFERENCES api_keys(id)\n);\n\n-- Add tenant_id to appropriate tables\nDO $$\nBEGIN\n    -- api_keys\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'api_keys' AND column_name = 'tenant_id') THEN\n        ALTER TABLE api_keys ADD COLUMN tenant_id VARCHAR;\n        CREATE INDEX idx_api_keys_tenant_id ON api_keys(tenant_id);\n    END IF;\n\n    -- api_groups\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'api_groups' AND column_name = 'tenant_id') THEN\n        ALTER TABLE api_groups ADD COLUMN tenant_id VARCHAR;\n        CREATE INDEX idx_api_groups_tenant_id ON api_groups(tenant_id);\n    END IF;\n\n    -- api_usage_logs\n    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'api_usage_logs' AND column_name = 'tenant_id') THEN\n        ALTER TABLE api_usage_logs ADD COLUMN tenant_id VARCHAR;\n        CREATE INDEX idx_usage_logs_tenant_id ON api_usage_logs(tenant_id);\n    END IF;\nEND $$;\n\n-- Create indexes for better performance\nCREATE INDEX IF NOT EXISTS idx_api_keys_email ON api_keys(email);\nCREATE INDEX IF NOT EXISTS idx_api_keys_hash ON api_keys(key_hash);\nCREATE INDEX IF NOT EXISTS idx_domains_email ON domains(email);\nCREATE INDEX IF NOT EXISTS idx_domains_verified ON domains(verified);\nCREATE INDEX IF NOT EXISTS idx_usage_logs_timestamp ON api_usage_logs(timestamp);\nCREATE INDEX IF NOT EXISTS idx_usage_logs_key_id ON api_usage_logs(key_id);\nCREATE INDEX IF NOT EXISTS idx_usage_logs_email ON api_usage_logs(email);\n\n-- Reference Data table\nCREATE TABLE IF NOT EXISTS reference_data (\n    id VARCHAR PRIMARY KEY,\n    email VARCHAR NOT NULL,\n    name VARCHAR NOT NULL,\n    data JSONB NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE NOT NULL,\n    FOREIGN KEY (email) REFERENCES user_preferences(email)\n);\n\nCREATE INDEX IF NOT EXISTS idx_reference_data_email ON reference_data(email);\n","log.target":"tokio_postgres::simple_query","log.module_path":"tokio_postgres::simple_query","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/simple_query.rs","log.line":47}}
{"timestamp":"2026-01-29T14:08:58.256948Z","level":"INFO","fields":{"message":"NOTICE: relation \"user_preferences\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.341403Z","level":"INFO","fields":{"message":"NOTICE: relation \"api_keys\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.361983Z","level":"INFO","fields":{"message":"NOTICE: relation \"api_groups\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362066Z","level":"INFO","fields":{"message":"NOTICE: relation \"endpoints\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362127Z","level":"INFO","fields":{"message":"NOTICE: relation \"user_groups\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362184Z","level":"INFO","fields":{"message":"NOTICE: relation \"user_endpoints\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362226Z","level":"INFO","fields":{"message":"NOTICE: relation \"parameters\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362277Z","level":"INFO","fields":{"message":"NOTICE: relation \"parameter_alternatives\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362319Z","level":"INFO","fields":{"message":"NOTICE: relation \"domains\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362360Z","level":"INFO","fields":{"message":"NOTICE: relation \"api_usage_logs\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362405Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_api_keys_email\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362448Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_api_keys_hash\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.362489Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_domains_email\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.382437Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_domains_verified\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.382544Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_usage_logs_timestamp\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.382602Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_usage_logs_key_id\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.382653Z","level":"INFO","fields":{"message":"NOTICE: relation \"idx_usage_logs_email\" already exists, skipping","log.target":"tokio_postgres::connection","log.module_path":"tokio_postgres::connection","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/connection.rs","log.line":338}}
{"timestamp":"2026-01-29T14:08:58.382728Z","level":"INFO","fields":{"message":"Schema executed successfully","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.382720+00:00"}}
{"timestamp":"2026-01-29T14:08:58.617274Z","level":"DEBUG","fields":{"message":"preparing query s0: SELECT COUNT(*) FROM domains WHERE email = 'system'","log.target":"tokio_postgres::prepare","log.module_path":"tokio_postgres::prepare","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/prepare.rs","log.line":121}}
{"timestamp":"2026-01-29T14:08:58.645405Z","level":"DEBUG","fields":{"message":"executing statement s0 with parameters: []","log.target":"tokio_postgres::query","log.module_path":"tokio_postgres::query","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/query.rs","log.line":45}}
{"timestamp":"2026-01-29T14:08:58.668960Z","level":"DEBUG","fields":{"message":"System domains already initialized","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.668951+00:00"}}
{"timestamp":"2026-01-29T14:08:58.669122Z","level":"INFO","fields":{"message":"Found endpoints config at: \"./endpoints.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.669116+00:00"}}
{"timestamp":"2026-01-29T14:08:58.669206Z","level":"INFO","fields":{"message":"Loading endpoints configuration from: \"./endpoints.yaml\"","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.669203+00:00"}}
{"timestamp":"2026-01-29T14:08:58.669862Z","level":"INFO","fields":{"message":"Successfully processed endpoints configuration","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.669860+00:00"}}
{"timestamp":"2026-01-29T14:08:58.669934Z","level":"DEBUG","fields":{"message":"preparing query s1: SELECT 1 as health_check","log.target":"tokio_postgres::prepare","log.module_path":"tokio_postgres::prepare","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/prepare.rs","log.line":121}}
{"timestamp":"2026-01-29T14:08:58.710151Z","level":"DEBUG","fields":{"message":"executing statement s1 with parameters: []","log.target":"tokio_postgres::query","log.module_path":"tokio_postgres::query","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/tokio-postgres-0.7.14/src/query.rs","log.line":45}}
{"timestamp":"2026-01-29T14:08:58.732472Z","level":"INFO","fields":{"message":"Database connection validated successfully","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.732464+00:00"}}
{"timestamp":"2026-01-29T14:08:58.732621Z","level":"INFO","fields":{"message":"Starting HTTP server on 127.0.0.1:5007","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.732618+00:00"}}
{"timestamp":"2026-01-29T14:08:58.733197Z","level":"INFO","fields":{"message":"Starting HTTP server at 127.0.0.1:5007","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.733191+00:00"}}
{"timestamp":"2026-01-29T14:08:58.733585Z","level":"INFO","fields":{"message":"starting 1 workers"}}
{"timestamp":"2026-01-29T14:08:58.733699Z","level":"INFO","fields":{"message":"Actix runtime found; starting in Actix runtime"}}
{"timestamp":"2026-01-29T14:08:58.733734Z","level":"INFO","fields":{"message":"starting service: \"actix-web-service-127.0.0.1:5007\", workers: 1, listening on: 127.0.0.1:5007"}}
{"timestamp":"2026-01-29T14:08:58.873253Z","level":"DEBUG","fields":{"message":"with_native_roots processed 156 valid and 0 invalid certs","log.target":"hyper_rustls::config","log.module_path":"hyper_rustls::config","log.file":"/Users/mb/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/hyper-rustls-0.24.2/src/config.rs","log.line":43}}
{"timestamp":"2026-01-29T14:08:58.874591Z","level":"INFO","fields":{"message":"Starting gRPC server on 0.0.0.0:50057","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.874586+00:00"}}
{"timestamp":"2026-01-29T14:08:58.874655Z","level":"INFO","fields":{"message":"All services started successfully","service":"store","component":"main","timestamp":"2026-01-29T14:08:58.874654+00:00"}}
